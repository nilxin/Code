/*******************************************************************************
 * Zuploader.js -  Zuploader Script library
 * Version v0.4.0
 * Copyright (C) 2016 zengchao
 *
 * @Author zengchao
 * @Email zengchao@sefonsoft.com
 * @UpdateTime (2016-06-27)
 *******************************************************************************/

(function($){$.fn.Zuploader=function(opts){var defaults={fileTypeExts:"",uploader:"",auto:false,method:"post",multi:true,formData:null,fileObjName:"file",totalFileSize:1024*20,fileSizeLimit:2048,fileMaxLimit:3,showUploadedPercent:true,showUploadedSize:false,buttonText:"选择文件",removeTimeout:1000,itemTemplate:'<div id="${fileID}" class="uploader-queue-item"><div class="uploader-progress"><div class="uploader-progress-bar"></div></div><span class="up_filename">${fileName}</span><span class="uploadbtn">上传</span><span class="delfilebtn">删除</span></div>',initData:[],onSelect:null,onUploadStart:null,onUploadSuccess:null,onUploadComplete:null,onUploadError:null,onInit:null,onCancel:null};var option=$.extend(defaults,opts);var formatFileSize=function(size,isKB){if(size>1024*1024&&!isKB){size=(Math.round(size*100/(1024*1024))/100).toString()+"MB"}else{size=(Math.round(size*100/1024)/100).toString()+"KB"}return size};var getFile=function(index,files){for(var i=0;i<files.length;i++){if(files[i].index==index){return files[i]}}return false};var getFileTypes=function(str){var result=[];var arr1=str.split(";");for(var i=0,len=arr1.length;i<len;i++){result.push(arr1[i].split(".").pop())}return result};this.each(function(){var _this=$(this);var instanceNumber=$(".uploader").length+1;var inputStr='<input id="select_btn_'+instanceNumber+'" class="selectbtn" style="display:none;" type="file" name="fileselect[]"';inputStr+=option.multi?" multiple":"";inputStr+=' accept="';inputStr+=getFileTypes(option.fileTypeExts).join(",");inputStr+='"/>';inputStr+='<a id="file_upload_'+instanceNumber+'-button" href="javascript:void(0)" class="uploader-button">';inputStr+=option.buttonText;inputStr+="</a>";var uploadFileListStr='<div id="file_upload_'+instanceNumber+'-queue" class="uploader-queue"></div>';_this.append(inputStr+uploadFileListStr);var fileObj={fileInput:_this.find(".selectbtn"),uploadFileList:_this.find(".uploader-queue"),url:option.uploader,totalSize:0,fileFilter:[],filter:function(files){var arr=[];var typeArray=getFileTypes(option.fileTypeExts);if(typeArray.length>0){for(var i=0,len=files.length;i<len;i++){var thisFile=files[i];if(parseInt(formatFileSize((this.totalSize+thisFile.size),true))>option.totalFileSize){this.alert("文件总大小超过限制!");break}if(parseInt(formatFileSize(thisFile.size,true))>option.fileSizeLimit){this.alert('文件"'+thisFile.name+'"的大小超出限制！');continue}if($.inArray(thisFile.name.split(".").pop(),typeArray)>=0){arr.push(thisFile)}else{this.alert('文件"'+thisFile.name+'"是不允许的文件类型！')}}}return arr},onSelect:function(files){option.onSelect&&option.onSelect(files,this.fileFilter);for(var i=0,len=files.length;i<len;i++){var file=files[i];var $html=$(option.itemTemplate.replace(/\${fileID}/g,"fileupload_"+instanceNumber+"_"+file.index).replace(/\${fileName}/g,file.name).replace(/\${fileSize}/g,formatFileSize(file.size)).replace(/\${instanceID}/g,_this.attr("id")));if(option.auto){$html.find(".uploadbtn").remove()}this.uploadFileList.append($html);if(option.showUploadedSize){var num='<span class="progressnum"><span class="uploadedsize">0KB</span>/<span class="totalsize">${fileSize}</span></span>'.replace(/\${fileSize}/g,formatFileSize(file.size));$html.find(".uploader-progress").after(num)}if(option.showUploadedPercent){var percentText='<span class="up_percent">0%</span>';$html.find(".uploader-progress").after(percentText)}if(option.auto){this.funUploadFile(file)}else{$html.find(".uploadbtn").on("click",(function(file){return function(){fileObj.funUploadFile(file)}})(file))}$html.find(".delfilebtn").on("click",(function(file){return function(){fileObj.funDeleteFile(file.index)}})(file))}},onProgress:function(file,loaded,total){var eleProgress=_this.find("#fileupload_"+instanceNumber+"_"+file.index+" .uploader-progress");var percent=(loaded/total*100).toFixed(2)+"%";if(option.showUploadedSize){eleProgress.nextAll(".progressnum .uploadedsize").text(formatFileSize(loaded));eleProgress.nextAll(".progressnum .totalsize").text(formatFileSize(total))}if(option.showUploadedPercent){eleProgress.nextAll(".up_percent").text(percent)}eleProgress.children(".uploader-progress-bar").css("width",percent)},funGetFiles:function(e){var files=e.target.files;if((this.fileFilter.length+1)>option.fileMaxLimit){this.alert("最多只能上传"+option.fileMaxLimit+"个文件！");return false}files=this.filter(files);for(var i=0,len=files.length;i<len;i++){for(var ii=0,lens=this.fileFilter.length;ii<len;ii++){var fileName=this.fileFilter[ii].name;if(fileName==files[i].name){var replaceQueueItem=confirm('命名的文件 "'+files[i].name+'" 已存在1.\n是否要替换现有文件?');if(!replaceQueueItem){return false}else{}}}this.fileFilter.push(files[i]);this.totalSize+=files.size}this.funDealFiles(files);return this},checkFileName:function(name){var result=false;var _this=this;$(this.fileFilter).each(function(k,v){if(v.name==name){_this.confirm('文件"'+name+'"已存在,是否替换现有文件？',function(sure){return sure},function(noSure){return noSure})}})},funDealFiles:function(files){var fileCount=_this.find(".uploader-queue .uploader-queue-item").length;
for(var i=0,len=files.length;i<len;i++){files[i].index=++fileCount;files[i].id=files[i].index}this.onSelect(files);return this},funDeleteFile:function(index){for(var i=0,len=this.fileFilter.length;i<len;i++){var file=this.fileFilter[i];if(file.index==index){this.fileFilter.splice(i,1);_this.find("#fileupload_"+instanceNumber+"_"+index).fadeOut();option.onCancel&&option.onCancel(file,this.fileFilter);break}}return this},funUploadFile:function(file){var xhr=false;try{xhr=new XMLHttpRequest()}catch(e){xhr=ActiveXobject("Msxml12.XMLHTTP")}if(xhr.upload){xhr.upload.addEventListener("progress",function(e){fileObj.onProgress(file,e.loaded,e.total)},false);xhr.onreadystatechange=function(e){if(xhr.readyState==4){if(xhr.status==200){var thisfile=_this.find("#fileupload_"+instanceNumber+"_"+file.index);thisfile.find(".uploader-progress-bar").css("width","100%");option.showUploadedSize&&thisfile.find(".uploadedsize").text(thisfile.find(".totalsize").text());option.showUploadedPercent&&thisfile.find(".up_percent").text("100%");option.onUploadSuccess&&option.onUploadSuccess(file,xhr.responseText);_this.find(".uploadbtn,.uploader-progress,.up_percent").remove()}else{option.onUploadError&&option.onUploadError(file,xhr.responseText)}option.onUploadComplete&&option.onUploadComplete(file,xhr.responseText);fileObj.fileInput.val("")}};option.onUploadStart&&option.onUploadStart();xhr.open(option.method,this.url,true);xhr.setRequestHeader("X-Requested-With","XMLHttpRequest");var fd=new FormData();fd.append(option.fileObjName,file);if(option.formData){for(var key in option.formData){fd.append(key,option.formData[key])}}xhr.send(fd)}},alert:function(msg,sure){this.modal({type:"alert",content:msg,btn:[{text:"确定",type:"sure",click:function(target){if(typeof sure=="function"){return sure(target)}}}]})},confirm:function(msg,sure,notSure){this.modal({type:"confirm",content:msg,btn:[{text:"是",type:"sure",click:function(target){if(typeof sure=="function"){return sure(target)}}},{text:"否",type:"notSure",click:function(target){if(typeof notSure=="function"){return notSure(target)}}}]})},modal:function(option){var container=$('<div class="Zuploader-modal-container">'+'<div class="Zuploader-modal-mask"></div>'+'<div class="Zuploader-modal-content">'+'<div class="Zuploader-modal-header"><span class="Zuploader-modal-title">Zuploader 提示您</span></div>'+'<div class="Zuploader-modal-body">'+option.content+"</div>"+'<div class="Zuploader-modal-footer"></div>'+"</div></div>");$(option.btn).each(function(k,v){var btn=$('<button class="Zuploader-modal-btn '+((v.type=="sure")?"sure":"")+'">'+v.text+"</button>");btn.bind("click",function(){if(typeof v.click=="function"&&v.type=="sure"){v.click(true)}else{if(typeof v.click=="function"&&v.type=="notSure"){v.click(false)}}$(".Zuploader-modal-container").remove()});container.find(".Zuploader-modal-footer").append(btn)});if(option.type=="alert"){container.find(".Zuploader-modal-mask").bind("click",function(){$(".Zuploader-modal-container").remove()})}$("body").append(container);var bodyHeight=container.find(".Zuploader-modal-content").height();container.find(".Zuploader-modal-content").css("margin-top",-bodyHeight/2)},initData:function(files){for(var i=0,len=files.length;i<len;i++){var file=files[i];var $html=$(option.itemTemplate.replace(/\${fileName}/g,file.name).replace(/\${fileID}/g,"fileupload_"+instanceNumber+"_"+(i+1)));var num='<span class="totalsize">'+formatFileSize(file.size)+"</span></span>";$html.find(".up_filename").before(num);$html.find(".uploadbtn,.uploader-progress").remove();this.uploadFileList.append($html);$html.find(".delfilebtn").on("click",(function(file){return function(){fileObj.funDeleteFile(file.index)}})(file));file.index=i+1;this.fileFilter.push(file);this.totalSize+=file.size}},init:function(){if(option.initData&&option.initData.length>0){fileObj.initData(option.initData)}if(this.fileInput.length>0){this.fileInput.change(function(e){fileObj.funGetFiles(e)})}_this.find(".uploader-button").on("click",function(){_this.find(".selectbtn").trigger("click")});option.onInit&&option.onInit()}};fileObj.init()})}})(jQuery);